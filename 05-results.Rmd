# Results
This is results.

```{r}
library(tidyverse)
library(choroplethr)
library(dplyr)
library(ggplot2)
library(USAboundaries)
library(plotly)
library(readxl)
library(ggpubr)
library(forcats)
library(viridis)
```

## Covid Cases
```{r}
#data process
# prepare population per states data
df_ppl <- read_excel("./data/nst-est2019-01.xlsx", range = c("A10:M60"),
                      col_names = c("geographic_area", "ppl2000","ppl2000est","0","1","2","3","4","5","6","7","8","ppl2019")) %>% 
  mutate(state = substring(geographic_area,2)) %>% 
  select("state","ppl2019")

# prepare covid cases df
df_case = read.csv("./data/us-states.csv") 


df_total_cases <-  df_case %>% 
  filter(date == "2020-11-29") 
df_total_cases <-  df_total_cases %>% 
  merge(x = df_total_cases , y=USAboundaries :: state_codes, by.x="state", by.y = "state_name")
df_total_cases <-  df_total_cases %>% 
  merge(x = df_total_cases , y=df_ppl, by.x="state", by.y = "state") %>% 
  mutate(case_ppl = cases/ppl2019) %>% 
  mutate(case_ppl_log = log(cases/ppl2019)) %>%
  mutate(case_log = log(cases))

df_total_cases$case_ppl <-  round(df_total_cases$case_ppl, 3)

df_total_cases$hover <- with(df_total_cases, paste(state, '<br>', "Covid cases",cases,"<br>",
                                                   "Covid cases per capita",case_ppl))
                   
```   
### Covid Maps
```{r}
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)


fig <- plot_geo(df_total_cases, locationmode = 'USA-states')

fig2 <- fig %>% add_trace(
    z = ~cases, text = ~hover, locations = ~state_abbr,
    color = ~cases, colors = 'Reds'
  )
fig2 <- fig2 %>% colorbar(title = "number of cases")
fig2 <- fig2 %>% layout(
    title = 'Positive cases of coronavirus in the United States<br>(Hover for breakdown)',
    geo = g
  )

fig2

```

This graph shows that the darkest states have the highest number of coronavirus cases. From this graph we can see that California, Texas, and Florida have the greatest number of cases, while the majority of central America seem to have few cases in comparison. In addition, hovering over each state will give more information on how many exact total cases are in each state. 

```{r}
fig1 <- fig %>% add_trace(
    z = ~case_ppl, text = ~hover, locations = ~state_abbr,
    color = ~case_ppl*100, colors = 'Reds'
  )
fig1 <- fig1 %>% colorbar(title = "number cases per capita")
fig1 <- fig1 %>% layout(
    title = 'Positive cases of coronavirus per capita in the United States<br>(Hover for breakdown)',
    geo = g
  )

fig1
```

In contrast to the first map, the second map now shows the number of positive covid cases per capita. This map can give more clear information on how each state is handling the pandemic as it takes population of each state into account. In the first map, it appeared as if California, Texas, and Florida were doing the worst with the pandemic. With this new map we can see that North Dakota is actually the state that is affected the most, as it has the most covid cases per capita, and that California and Texas pale in comparison to other states in Central America. 

```{r}


library(parcoords)
df_ppc_case <- df_total_cases 
rownames(df_ppc_case) <- df_ppc_case$state 
df_ppc_case <- df_ppc_case%>% 
  select('cases','case_ppl') %>% 
  rename(cases_per_capita = case_ppl)

parcoords(df_ppc_case,
          reorderable = T,
          brushMode = '1D-axes')

```

This parallel coordinates plot is another representation of how each state is being affected by the coronavirus pandemic. From this graph, we can observe that high number of cases in the state does not directly coordinate to high cases per capita, and that most of the states with low covid case numbers actually have more cases per capita. 

### Covid19 Cases in Time Series
```{r}
#data process, us_cases1 is the overall us cases per day
us_cases1 <- df_case  %>% 
  count(date,wt = cases,name = "total_cases") %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(new_cases = (c(1,diff(total_cases))))
```

```{r}
ggplot(us_cases1,aes(x=date,y=total_cases)) +
  geom_line(color="#69b3a2") + 
  scale_x_date(date_breaks = "1 month", date_labels = "%b")+
  theme_light()+
  ggtitle("Cumulative Covid19 Cases in the US")
```

This graph shows the cummulative number of covid cases starting from February of 2020 to December of 2020. As shown, it looks like the first case of the coronavirus was reported in the United States in February, and has had an exponential trend in the number of cases since then. Specifically from September to December, cases almost doubled from the first eight months.

```{r}
ggplot(us_cases1,aes(date,new_cases)) +
  geom_line(color="#69b3a2") + 
  geom_smooth(method = "loess", se = FALSE,span=0.2, lwd = 0.8) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")+
  theme_light(16)+
  ylab("daily new cases")+
  ggtitle("Daily New Covid19 Cases in the US")

```

This graph plots time series data of the covid cases from the first case in the US in February of 2020 to December of 2020. While there have been minor dips in the daily number of cases such as in June and September, there is mostly an upwards trend, specifically a spike from November to December. 

## County
```{r}
county <- read.csv("./data/state_policy_updates_20201202_0721.csv")
county_policy <- county[county$policy_level=='county' & county$start_stop=='start',]
county_policy$policy_type <- as.factor(county_policy$policy_type)
ggplot(county_policy, aes(fct_rev(fct_infreq(policy_type)))) + 
  geom_bar() +
  coord_flip() +
  ggtitle("County Frequency of Policy Types") +
  xlab("Policy Types")
```

We see that over 400 counties have enacted Shelter in Place policies. Other regulations such as food and drink, mask requirement are also very common. There are only 23 different policies across all the counties. On the other hand, there were 59 different policies across the 50 states with may only enacted by 1 state. This is also due to inconsistency in the naming of these policies across states.
```{r}
state <- county[county$policy_level == "state",]
ggplot(state[state$start_stop=='start',], aes(fct_rev(fct_infreq(policy_type)))) + 
  geom_bar() +
  coord_flip() +
  ggtitle("State Frequency of Policy Types") +
  xlab("Policy Types")
```

Some policies, however, have almost states enacting it. For example, regulations on entertainment, food and drink, and non-essential businesses.

## Hospital
All hospital data is from November 26, 2020.
```{r}
hospital <- read.csv("./data/reported_hospital_utilization_20201130_2136.csv")
staff_shortage <- c(1:7)
inpatient_bed <- c(1, 10:15)
prev_day <- c(1, 16:23)
staffed <- c(1, 24:29)
total <- c(1, 30:39)
inpatient_bed <- c(1, 40:51)
icu_bed <- c(1, 52:59)
staff_shortage_df <- hospital[,staff_shortage]
inpatient_bed_df <- hospital[,inpatient_bed]
prev_day_df <- hospital[,prev_day]
total_df <- hospital[,total]
inpatient_bed_df <- hospital[,inpatient_bed]
icu_bed_df <- hospital[,icu_bed]
```

We want to analyze the bed usage in hospitals through visualizations below.
```{r}
total_bed <- hospital$inpatient_beds

covid_bed <- hospital$inpatient_beds_used_covid
not_covid_bed <- hospital$inpatient_beds_used - covid_bed
empty_bed <- total_bed - hospital$inpatient_beds_used
state <- as.factor(hospital$state)

bed_usage <- data.frame(state, covid_bed, not_covid_bed, empty_bed)
bed_usage_tidy <- bed_usage %>% 
  mutate(covid_bed_perc = covid_bed/(covid_bed+not_covid_bed+empty_bed)) %>% 
  pivot_longer(cols = !c(state,covid_bed_perc), names_to = "bedtype", values_to = "count") %>% 
  mutate(state = fct_reorder(state, desc(-covid_bed_perc))) %>% 
  mutate(bedtype = factor(bedtype, level = c("covid_bed","empty_bed","not_covid_bed")))

  ggplot(bed_usage_tidy,aes(x = state , y = count, fill = (bedtype))) + 
    geom_bar(,stat = "identity", position = position_fill(reverse = TRUE)) + 
    scale_y_continuous(labels = scales::percent_format()) +
    labs(x = 'state') +
    coord_flip() +
    ylab("proportion") + 
    xlab("State") +
    theme(legend.position = "bottom") +
    ggtitle("Inpatient Bed Usage by State")
```

Through this chart, we see that the majority of beds occupied for all states are not covid related. States such as North and South Dakota have over 20% of their bed usage on covid-19 patients. As of November 26, there are more empty beds than beds occupied by covid patients. However, that difference is not very large in many states that may have less beds overall. To build on this intuition, we will explore the hospital's own expressions about having a critical staffing shortage.

```{r}
staff_short_prop <- hospital$critical_staffing_shortage_today_yes / (hospital$critical_staffing_shortage_today_yes+hospital$critical_staffing_shortage_today_no)
staff_short_df <- data.frame(hospital$state, staff_short_prop)

ggplot(staff_short_df, aes(x=staff_short_prop)) + 
  geom_histogram(binwidth=0.05, center=0.025, closed='left') +
  scale_y_continuous(breaks=c(0, 2, 4, 6, 8, 10)) +
  #scale_x_continuous(breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6)) +
  ggtitle("Number of States with x% Hospitals with Critical Staffing Shortage") +
  xlab("% of Hospitals with Critical Staffing Shortage") +
  ylab("Number of States")
```

This histogram demonstrates the percentage of hospitals within a State that reported critical staffing shortages in regards to open bed space. We see that many states have more than 20% of their hospitals reporting critical staffing shortage as of November 26. This provides further insight in our previous chart because even though there seemingly are many empty beds left, hospitals themselves have reported critical shortages.

## Covid Impact on Airlines

```{r}
#Data Transformation
data <- read_excel("./data/scheduled-canceled-operated-flights-jan2019-jul2020.xlsx")

year <- c(2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019,
          2019, 2019, 2020, 2020, 2020, 2020, 2020, 2020, 2020)
my_data <- data.frame(year)

for (val in 2:length(data)){
  array <- data[val][[1]]
  array <- array[5:23]
  my_data <- cbind(my_data, array)
}

#rename the columns 
names <- c("year", "month", "Tot_Flights", "Alaska",
           "Allegiant", "American", "Delta", "Frontier", "Hawaiian", 
           "JetBlue", "Southwest", "Spirit", "United")
names(my_data) <- names 

#convert to numeric 
my_data$Tot_Flights <- as.numeric(my_data$Tot_Flights)
my_data$Alaska <- as.numeric(my_data$Alaska)
my_data$Allegiant <- as.numeric(my_data$Allegiant)
my_data$American <- as.numeric(my_data$American)
my_data$Delta <- as.numeric(my_data$Delta)
my_data$Frontier <- as.numeric(my_data$Frontier)
my_data$Hawaiian <- as.numeric(my_data$Hawaiian)
my_data$JetBlue <- as.numeric(my_data$JetBlue)
my_data$Southwest <- as.numeric(my_data$Southwest)
my_data$Spirit <- as.numeric(my_data$Spirit)
my_data$United <- as.numeric(my_data$United)
```

Something to point out in this airline dataset is that only the data for the first 7 months of 2020 is given, from January to July, and thus, the graphs including 2019 data will only include the data from the first seven months to make proper observations.

```{r}
tot_flights_2019 <- sum(my_data['Tot_Flights'][[1]][1:7])
tot_flights_2020 <- sum(my_data['Tot_Flights'][[1]][13:19])
tot_flight_data <- data.frame("year" = c("2019", "2020"), 
                              "flights" = c(tot_flights_2019, tot_flights_2020))
ggplot(tot_flight_data, aes(x = year, y = flights)) +
  geom_bar(stat = "identity") +
  ggtitle("Bar Graph of Total Flights in First 7 Months 2019 vs. 2020") + 
  scale_color_viridis() 
```

Therefore, using only the first 7 months of the 2019 data to compare its results more accuractely with the first 7 months of the 2020 data, we see a clear distinctment between the number of flights taken in 2019 vs. 2020, observing that the pandemic could have played a role in this distinctment. Let us see use covid case data to detect the pattern of how the number of coronavirus cases in the United States affected the number of flights taken in and out of the US.

```{r}
data_2020 <- my_data[my_data$year==2020, ]

df_jan_cases <-  df_case %>% 
  filter(date == "2020-01-29")
jan_cases <- sum(df_jan_cases$cases)
df_feb_cases <-  df_case %>% 
  filter(date == "2020-02-29")
feb_cases <- sum(df_feb_cases$cases) - sum(df_jan_cases$cases)
df_mar_cases <-  df_case %>% 
  filter(date == "2020-03-29")
mar_cases <- sum(df_mar_cases$cases) - sum(df_feb_cases$cases)
df_apr_cases <-  df_case %>% 
  filter(date == "2020-04-29")
apr_cases <- sum(df_apr_cases$cases) - sum(df_mar_cases$cases)
df_may_cases <-  df_case %>% 
  filter(date == "2020-05-29")
may_cases <- sum(df_may_cases$cases) - sum(df_apr_cases$cases)
df_jun_cases <-  df_case %>% 
  filter(date == "2020-06-29")
jun_cases <- sum(df_jun_cases$cases) - sum(df_may_cases$cases)
df_jul_cases <-  df_case %>% 
  filter(date == "2020-07-29") 
jul_cases <- sum(df_jul_cases$cases) - sum(df_jun_cases$cases)

month_cases <- c(jan_cases, feb_cases, mar_cases, apr_cases, may_cases, jun_cases, jul_cases)

data_2020 <- cbind(data_2020, month_cases)
tidydf <- data_2020 %>%
  mutate(cases =round(100*month_cases/month_cases[4], 2)) %>%
  mutate(flights = round(100*Tot_Flights/Tot_Flights[4], 2))

tidydf <- tidydf %>% select(month, cases, flights) %>%
  gather(key = "variable", value = "value", -month)


p1 <- ggplot() +
  geom_line(data = data_2020, aes(x=fct_inorder(month), y=Tot_Flights, group=1), color="#481567FF") + 
  geom_point(size = 4) + 
  theme(axis.text.x=element_text(angle=60, hjust=1))+
  theme_light()+
  ggtitle("Total Flights in 2020 in the US") + 
  xlab("Month") + 
  ylab("Total Flights") 

p2<- ggplot() +
  geom_line(data = data_2020 , aes(x=fct_inorder(month), y=month_cases, group=1), color="#55C667FF") + 
  geom_point(size = 4) + 
  theme(axis.text.x=element_text(angle=60, hjust=1))+
  theme_light()+
  ggtitle("COVID cases per Month in US") + 
  xlab("Month") + 
  ylab("Total Cases") 

ggarrange(p1,p2,nrow=2)

```

This graph shows when the coronavirus hit the United States hard, and affected many different factors, one being the airline industry. Although there were cases in January, the number of cases quickly ramped up from March to April, which correlates with the decline in travel. From the graph, it can be seen that around May, although cases were still increasing, travel started to increase again, as people started to most likely relax on restrictions. 

```{r}
#See how much percent each airline was affected 
percent_changes <- c() 
for (val in 4:(length(data_2020)-1)){
  array <- data_2020[val][[1]]
  percent_change <- 
    ((sum(array[1:3]) - sum(array[4:7])) / 
       sum(array[1:3])) * 100 
  percent_changes <- append(percent_changes, percent_change)
}

airlines <- c("Alaska","Allegiant", "American", "Delta", "Frontier", "Hawaiian", "JetBlue", "Southwest", "Spirit", "United")

ggplot(data.frame(airlines, percent_changes), 
       aes(reorder(airlines, -percent_changes), percent_changes)) +
  geom_bar(stat = "identity") +
  ggtitle("Bar Graph of Percent Decrease for each Airline") + 
  xlab("Airline") + 
  ylab("Percent Decrease") + 
  scale_color_viridis()
```

This data shows by how much percent the number of flights in
each airline decreased from the first couple months, pre-covid,
to the rest of the year, after the oncoming of the pandemic in
the United States. As shown by the graph, every single airline
was affected by the pandemic as they all have a positive percent
change, meaning that there was a decline in the number of flights
for each airline. The airlines that were affected the most were
JetBlue, Hawaiian, and United. These airlines had at least a 60%
decline in flights when the pandemic started.

```{r}
top_drops <- data_2020 %>%
  select(month, JetBlue, Hawaiian, United, Delta) %>%
  gather(key = "Airline", value = "value", -month)

ggplot(top_drops, aes(fct_inorder(month), value, group = Airline)) + 
  geom_line(aes(color = Airline), size = 1) +
  geom_point() + 
  ggtitle("Top 4 Airline Brands Affected") + 
  xlab("Month") + 
  ylab("Flights") +
  scale_color_viridis(discrete=TRUE) +
  theme_bw()
```

This graph shows the pattern of the top four airline brands affected, taken from the previous graph. The trends stay consistent with the trends that we've been seeing in the previous graphs. 

#### Final Findings on Airline Data 

The most revealing findings from this exploratory data analysis showed a couple of things. Firstly, there was a major decrease in flights from the year 2019 to the year 2020. Secondly, the number of flights mainly dropped in April of 2020, correlating with the time that the lockdown started and travel restrictions were placed everywhere. Looking at each airline, there was a decrease of the total number of flights taken for each airline, showing that almost every airline industry was affected by the pandemic. Some airlines had a decrease in flights by more than 60%, showing the intensity of the effect on the airline industry. More than half of their revenue was gone. Overall, in terms of the effect on travel during the coronavirus pandemic, there are clear patterns that show that travel was greatly affected. Airplanes were not a first choice method of transporation anymore, as people were not even travelling in the first place. This major decline in airline transportation and travel in and out of the United States, shows how greatly the pandemic played a role in the decline of the airline industry. 


## Covid Impact on Restaurants